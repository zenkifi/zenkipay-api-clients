# This GitHub Actions workflow was generated by the `Zenkipay team` on 2023-01-27
name: Build and publish SDKs clients

on:
  push:
    branches:
      # This workflow will run every time you push code to the following branch: `main`
      # Check out GitHub's docs for more info on configuring this:
      # https://docs.github.com/actions/using-workflows/events-that-trigger-workflows
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NewVersion:
    steps:
      - name: Checkout local repository zenkipay-api-clients-sdk
        uses: actions/checkout@v3

      - name: Checkout repository zenkipay-api
        uses: actions/checkout@v3
        with:
          repository: zenkifi/zenkipay-api
          path: zenkipay-api
          token: ${{ secrets.SECRET_CI_TOKEN }}

      - name: Checkout repository zenkipay-api
        uses: actions/checkout@v3
        with:
          repository: zenkifi/zenkipay-api-sdk-java
          path: zenkipay-api-sdk-java
          token: ${{ secrets.SECRET_CI_TOKEN }}

      - name: Actualizando especificación de Zenkipay API
        run: |
          echo "HOME -> $HOME"
          echo "GITHUB_PATH -> $GITHUB_PATH"

          echo "Borrando archivo de especificación"
          rm src/main/resources/Zenkipay-API-v1-EN.yaml

          echo "Actualizando archivo de especificación"
          cp zenkipay-api/Zenkipay-API-v1-EN.yaml src/main/resources/

      - name: Generando archivos de compilación basado en la versión de API enviada
        run: |
          echo "Generando archivo build para compilar version actual en librerías"
          NewVersion=$(cat ZenkipayApiLastVersion.txt)
          echo $NewVersion
          sed "s/@:VERSION:@/$NewVersion/g" template-build-java.gradle > build-java.gradle
          cat build-java.gradle


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Configurando Gradlew
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: release-candidate

      - name: SDK Java - Ejecutando Gradlew para generar los SDK's
        run: |
          echo "Ejecutando gradlew"
           ./gradlew --stacktrace -b build-java.gradle clean openApiValidate openApiGenerate changePermission

      - name: SDK Java - Ejecutando maven para generar librerías de cliente
        run: |
          echo "Actual Path"
          cd build/zenkipay-sdk/java/
          echo "Ejecutando Maven"
          mvn clean compile package --file pom.xml

      - name: SDK Java - actualizando archivo de CI
        run: |
          echo "Actualizando maven ci"
          cd build/zenkipay-sdk/java/.github/workflows
          sed 's/8/11/g' maven.yml > maven_tmp.yml
          rm maven.yml
          mv maven_tmp.yml maven.yml
          
          sed 's/Java CI with Maven/Run test/g' maven.yml > maven_tmp.yml
          rm maven.yml
          mv maven_tmp.yml maven.yml

      - name: SDK Java - Moviendo artefactos a directorio de liberaciones
        run: |
          echo "Actual Path"
          pwd
          ls -la
          cd build/zenkipay-sdk/java/
          ls -la
          ls -la ../../../
          ls -la ../../../zenkipay-api-sdk-java
          pwd
          
          echo "Creando directorio con la versión por liberar"
          if test -d "../../../zenkipay-api-sdk-java/Release"; then
            echo "Dir ../../../zenkipay-api-sdk-java/Release exists."
          else
            mkdir ../../../zenkipay-api-sdk-java/Release
          fi
          if test -d "../../../zenkipay-api-sdk-java/Release/SDK-Java"; then
            echo "Dir ../../../zenkipay-api-sdk-java/Release/SDK-Java exists."
          else
            mkdir ../../../zenkipay-api-sdk-java/Release/SDK-Java
          fi
          if test -d "../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0"; then
            echo "Dir ../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0 exists."
          else
            mkdir ../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0
          fi
          
          ls -la ../../../
          ls -la ../../../zenkipay-api-sdk-java
          
          echo "Moviendo artefactos para hacer commit"
          cp -rfv .github ../../../zenkipay-api-sdk-java
          cp -rfv api ../../../zenkipay-api-sdk-java
          cp -rfv docs ../../../zenkipay-api-sdk-java
          cp -rfv gradle ../../../zenkipay-api-sdk-java
          cp -rfv src ../../../zenkipay-api-sdk-java
          cp -rfv .gitignore ../../../zenkipay-api-sdk-java
          cp -rfv build.gradle ../../../zenkipay-api-sdk-java
          cp -rfv gradle.properties ../../../zenkipay-api-sdk-java
          cp -rfv gradlew ../../../zenkipay-api-sdk-java
          cp -rfv gradlew.bat ../../../zenkipay-api-sdk-java
          cp -rfv pom.xml ../../../zenkipay-api-sdk-java
          cp -rfv README.md ../../../zenkipay-api-sdk-java
          cp -rfv settings.gradle ../../../zenkipay-api-sdk-java
          cp -rfv target/zenkipay-api-client-1.0.0-RELEASE.jar ../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0/
          cp -rfv target/zenkipay-api-client-1.0.0-RELEASE-javadoc.jar ../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0/
          pwd
          ls -la
          ls -la ../../../
          ls -la ../../../zenkipay-api-sdk-java/

      - name: Subiendo librerías de SDK Java
        run: |
          pwd
          ls -la
          cd zenkipay-api-sdk-java

          echo "README original"
          cat README.md

          echo "Reemplazar el titulo de la librería y agregar el badge"
          sed '1s/^/![example workflow](https:\/\/github.com\/zenkifi\/zenkipay-api-sdk-java\/actions\/workflows\/maven.yml\/badge.svg)\r\n/' README.md > README_tmp.md
          rm README.md
          mv README_tmp.md README.md
          
          echo "README con badge"
          cat README.md
          
          sed 's/# zenkipay-api-client/# Zenkipay API SDK for JAVA/g' README.md > README_tmp.md
          rm README.md
          mv README_tmp.md README.md
          
          echo "Version final de README"
          cat README.md

          pwd
          ls -la
  
          git config user.name github-actions
          git config user.email github-actions@github.com
          echo "Haciendo commit"
          git add .github
          git add api
          git add docs
          git add gradle
          git add src
          git add .gitignore
          git add build.gradle
          git add gradle.properties
          git add gradlew
          git add gradlew.bat
          git add pom.xml
          git add README.md
          git add settings.gradle
          git add Release/SDK-Java/v1.0.0/zenkipay-api-client-1.0.0-RELEASE.jar
          git add Release/SDK-Java/v1.0.0/zenkipay-api-client-1.0.0-RELEASE-javadoc.jar
          git commit -m "Se suben cambios a clientes SDK por cambios en la especificación de API"
          git push