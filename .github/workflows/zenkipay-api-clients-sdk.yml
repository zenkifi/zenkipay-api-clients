# This GitHub Actions workflow was generated by the `Zenkipay team` on 2023-01-27
name: Build and test SDKs clients

on:
  push:
    branches:
      # This workflow will run every time you push code to the following branch: `main`
      # Check out GitHub's docs for more info on configuring this:
      # https://docs.github.com/actions/using-workflows/events-that-trigger-workflows
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout local repository zenkipay-api-clients-sdk
        uses: actions/checkout@v3

      - name: Checkout repository zenkipay-api
        uses: actions/checkout@v3
        with:
          repository: zenkifi/zenkipay-api
          path: zenkipay-api

      - name: Checkout repository zenkipay-api
        uses: actions/checkout@v3
        with:
          repository: zenkifi/zenkipay-api-sdk-java
          path: zenkipay-api-sdk-java

      - name: Actualizando especificación de Zenkipay API
        run: |
          echo "HOME -> $HOME"
          echo "GITHUB_PATH -> $GITHUB_PATH"

          echo "Borrando archivo de especificación"
          rm src/main/resources/Zenkipay-API-v1-EN.yaml

          echo "Actualizando archivo de especificación"
          cp zenkipay-api/Zenkipay-API-v1-EN.yaml src/main/resources/

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Configurando Gradlew
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: release-candidate

      - name: SDK Java - Ejecutando Gradlew para generar los SDK's
        run: |
          echo "Ejecutando gradlew"
           ./gradlew --stacktrace -b build-java.gradle clean openApiValidate openApiGenerate changePermission

      - name: SDK Java - Ejecutando maven para generar librerías de cliente
        run: |
          echo "Actual Path"
          cd build/zenkipay-sdk/java/
          echo "Ejecutando Maven"
          mvn clean compile package --file pom.xml

      - name: SDK Java - Moviendo artefactos a directorio de liberaciones
        run: |
          echo "Actual Path"
          pwd
          ls -la
          echo "Ejecutando Maven"
          cd build/zenkipay-sdk/java/
          ls -la
          mvn clean compile package --file pom.xml
          
          echo "Creando directorio con la versión por liberar"
          if test -d "../../../zenkipay-api-sdk-java/Release"; then
            echo "Dir ../../../zenkipay-api-sdk-java/Release exists."
          else
            mkdir ../../../zenkipay-api-sdk-java/Release
          fi
          if test -d "../../../zenkipay-api-sdk-java/Release/SDK-Java"; then
            echo "Dir ../../../zenkipay-api-sdk-java/Release/SDK-Java exists."
          else
            mkdir ../../../zenkipay-api-sdk-java/Release/SDK-Java
          fi
          if test -d "../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0"; then
            echo "Dir ../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0 exists."
          else
            mkdir ../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0
          fi
          
          echo "Moviendo artefactos para hacer commit"
          cp -rfv .github ../../../zenkipay-api-sdk-java
          cp -rfv .openapi-generator ../../../zenkipay-api-sdk-java
          cp -rfv api ../../../zenkipay-api-sdk-java
          cp -rfv docs ../../../zenkipay-api-sdk-java
          cp -rfv gradle ../../../zenkipay-api-sdk-java
          cp -rfv src ../../../zenkipay-api-sdk-java
          cp -rfv target/zenkipay-api-client-1.0.0-RELEASE.jar ../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0/
          cp -rfv target/zenkipay-api-client-1.0.0-RELEASE-javadoc.jar ../../../zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0/
          pwd
          ls -la
          ls -la ../../../zenkipay-api-sdk-java/

      - name: Subiendo librerías de SDK Java
        run: |
          pwd
          ls -la
          cd zenkipay-api-sdk-java

          git config user.name github-actions
          git config user.email github-actions@github.com
          git add zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0/zenkipay-api-client-1.0.0-RELEASE.jar
          git add zenkipay-api-sdk-java/Release/SDK-Java/v1.0.0/zenkipay-api-client-1.0.0-RELEASE-javadoc.jar
          git commit -m "Se suben cambios a clientes SDK por cambios en la especificación de API"
          git push